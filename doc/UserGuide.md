# User Guide

## Introduction

The workflow in Jagen is organized around projects (also called "build roots")
which consist of a number of "layers". Each layer can provide rules,
configuration, "pkg" files, patches and other resources which are used to
generate a build system and environment of the project. This build system
tracks packages dependencies, allows rebuilding of the parts or the whole
project and managing of the source directories.

Typically, you have project's environment (`env.sh`) sourced in a terminal and
do all actions related to the project from this terminal window. This way you
will have Shell command auto-completion working properly, toolchains and tools
compiled for the host in you PATH so you can run them directly or perform some
other actions manually. For non-interactive work (such as launching the build
from an IDE) there is a `jagen` script in each project's directory which
initializes the environment before redirecting the command to the Jagen's
instance. Running this script does not change the current Shell environment.

## Requirements

- [Lua](https://www.lua.org) 5.1 or 5.2 ([LuaJIT](http://luajit.org) 2.0 works too)
- [Ninja build](https://ninja-build.org)
- [ccache](https://ccache.samba.org) is recommended if you plan to compile a lot of C/C++ code 

On Ubuntu Linux you can install those using the command:

    sudo apt-get install lua5.1 ninja-build ccache

## Initialization

Use the `init` script in the root of Jagen source directory to initialize the
current directory as the project. The script should be ran reaching out by a
relative path to the checked out Jagen sources like so:

    git clone https://github.com/bazurbat/jagen.git
    mkdir jagen-project && cd jagen-project
    ../jagen/init

Or it can be piped to Shell directly from the network:

    mkdir jagen-project && cd jagen-project
    curl -fsSL https://raw.githubusercontent.com/bazurbat/jagen/master/init | sh

This will clone the Jagen itself into the `.jagen` subdirectory of the project.

Having shared Jagen sources allows you to build several projects using the same
Jagen version which can be more convenient if you have a lot of projects or are
following the master closely, while piping produces more self-contained project
and makes it easier to move it around.

A clean project has the following layout:

    .
    ├── bin
    ├── build
    │   └── build.ninja
    ├── config.sh
    ├── env.sh
    ├── include
    ├── jagen
    └── log

The `env.sh` file contains the location to Jagen directory and PATH settings.
Source it to start working with this project interactively. If the project or
Jagen source is moved relative to each other this file should be regenerated by
using the `init` again. Please do not mix the environments from different
projects in a single Shell instance, this will likely produce unexpected
results.

The `config.sh` file contains global project settings such as layers, flags and
locations of dist and source directories. The initial template is generated by
the `init` script but afterwards it is supposed to be modified manually. The
previous version is backed up as `config.sh.bak` if you forced init for an
existing project.

The `jagen` script runs a single command with the environment of the project
where the script is located. Use it for one-time jobs.

The `build/build.ninja` file contains the generated build system for the Ninja
build system according to the project's rules. It is recreated every time on
"refresh", "clean" or "build" commands.

Others are directories which may exist depending on the configuration.

Path     | Description
---------|------------
/bin     | generated helper scripts
/build   | build system working directories and artifacts
/dist    | the downloaded distribution archives and files
/host    | install root for 'host' configuration
/include | package-specific include scripts generated from rules
/lib     | project-specific rules and pkg scripts (the project layer)
/log     | build log files
/src     | checked out sources for SCM packages
/target  | install root for 'target' configuration

### Initialization options

The `init` script has the following options:

Option      | Description
------------|------------
-h, --help  | show usage information
-a, --flag  | add the flag to `jagen_flags`
-f, --force | force the initialization of a non-empty directory
-L          | add the directory to `jagen_layer_path`

Note that to use the parameters when piping to Shell you need to separate them
from the Shell's own arguments by `--` like so:

    curl -fsSL https://raw.githubusercontent.com/bazurbat/jagen/master/init | \
        sh -s -- -a ccache -f

to add `ccache` flag and initialize with force.

The following flags are available in the core:
  
 - `ccache`  — enables the usage of `ccache` for all toolchain commands
 - `offline` — skips operations requiring network, if possible

Projects can have their own additional flags. Adjust the list of flags after
the initialization by setting the `jagen_flags` variable in `config.sh` file.

Reinitializing of an existing project is possible with `--force` option but
note that this will recreate the `config.sh`. The previous version will be
saved as `config.sh.bak`. Copy your old settings from it manually if necessary.

The list of an initial project layers can be given after the options. The
relative paths should be specified as observed from the project's directory
which is the current directory when running the init command.

The details of using the `-L` option are out of scope of this guide for now.

# Reference

- [Initializing](Initializing.md)
- [List Information](List.md)
- [Building](Building.md)
- [Cleaning](Cleaning.md)
- [Targets](Manual.md#targets)
- [Managing package sources](ManagingSources.md)
- [Manage filesystem images](Images.md)
- [Install Bash completions](Installation.md)
- [Writing build scripts](Manual.md#writing-build-scripts)
- [Build system internals](Manual.md#build-system-internals)
